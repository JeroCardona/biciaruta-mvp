<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>BiciRuta — MVP</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body{font-family: system-ui, sans-serif; margin:0; padding:16px;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    #map{height:80vh; border-radius:12px;}
    button{margin-right:8px; padding:8px 12px; border-radius:8px; border:1px solid #ddd; cursor:pointer}
  </style>
</head>
<body>
  <header>
    <h3>BiciRuta — MVP</h3>
    <div>
      <button id="btnReport">Reportar incidente aquí</button>
      <button id="btnNear">Ver cercanos</button>
    </div>
  </header>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([6.2442, -75.5812], 13); // Medellín
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    let centerMarker = L.marker(map.getCenter()).addTo(map);
    map.on('moveend', ()=> centerMarker.setLatLng(map.getCenter()));

    async function postJSON(url, body) {
      const r = await fetch(url, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if (!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    document.getElementById('btnReport').onclick = async ()=>{
      try{
        const {lat, lng} = map.getCenter();
        const resp = await postJSON('/api/reports', { lat, lon: lng, type:'obstaculo', note:'bache' });
        alert('Reporte enviado: ID '+resp.id);
      }catch(e){ alert('Error al reportar'); console.error(e); }
    };

    document.getElementById('btnNear').onclick = async ()=>{
      try{
        const {lat, lng} = map.getCenter();
        const r = await fetch(`/api/reports/near?lat=${lat}&lon=${lng}&radius=0.01`);
        const data = await r.json();
        data.forEach(d=> L.circleMarker([d.lat, d.lon]).addTo(map).bindPopup((d.type||'incidente')));
      }catch(e){ alert('Error consultando cercanos'); console.error(e); }
    };
  </script>
</body>
</html>
